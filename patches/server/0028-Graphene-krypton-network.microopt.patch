From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: satvrn <pastawho@gmail.com>
Date: Tue, 26 Sep 2023 20:09:46 -0700
Subject: [PATCH] Graphene (krypton): network.microopt


diff --git a/src/main/java/net/minecraft/network/Utf8String.java b/src/main/java/net/minecraft/network/Utf8String.java
index 7b39060cde0ec31c4adf36960b33cefcd5138527..783cd68b7db5a952085068561ff22c4ab84ccf12 100644
--- a/src/main/java/net/minecraft/network/Utf8String.java
+++ b/src/main/java/net/minecraft/network/Utf8String.java
@@ -31,6 +31,8 @@ public class Utf8String {
     }
 
     public static void write(ByteBuf buf, CharSequence string, int length) {
+        // Graphene start - krypton: optimized version
+        /*
         if (string.length() > length) {
             throw new EncoderException("String too big (was " + string.length() + " characters, max " + length + ")");
         } else {
@@ -51,5 +53,22 @@ public class Utf8String {
             }
 
         }
+        */
+        // Graphene end
+
+        // Graphene start - krypton: network.microopt
+        // Mojang _almost_ gets it right, but stumbles at the finish line...
+        if (string.length() > length) {
+            throw new EncoderException("String too big (was " + string.length() + " characters, max " + length + ")");
+        }
+        int utf8Bytes = ByteBufUtil.utf8Bytes(string);
+        int maxBytesPermitted = ByteBufUtil.utf8MaxBytes(length);
+        if (utf8Bytes > maxBytesPermitted) {
+            throw new EncoderException("String too big (was " + utf8Bytes + " bytes encoded, max " + maxBytesPermitted + ")");
+        } else {
+            VarInt.write(buf, utf8Bytes);
+            buf.writeCharSequence(string, StandardCharsets.UTF_8);
+        }
+        // Graphene end
     }
 }
diff --git a/src/main/java/net/minecraft/network/VarInt.java b/src/main/java/net/minecraft/network/VarInt.java
index 18d5a22ad3ef4cb279475531dbc2c65e07c69929..06d35230679aa3ee7df72945ae6847f1e0011448 100644
--- a/src/main/java/net/minecraft/network/VarInt.java
+++ b/src/main/java/net/minecraft/network/VarInt.java
@@ -3,12 +3,18 @@ package net.minecraft.network;
 import io.netty.buffer.ByteBuf;
 
 public class VarInt {
+    // Graphene start - now unused
+    /*
     private static final int MAX_VARINT_SIZE = 5;
     private static final int DATA_BITS_MASK = 127;
     private static final int CONTINUATION_BIT_MASK = 128;
     private static final int DATA_BITS_PER_BYTE = 7;
+    */
+    // Graphene end
 
     public static int getByteSize(int i) {
+        // Graphene start - krypton: optimized version
+        /*
         for(int j = 1; j < 5; ++j) {
             if ((i & -1 << j * 7) == 0) {
                 return j;
@@ -16,6 +22,10 @@ public class VarInt {
         }
 
         return 5;
+        */
+        // Graphene end
+
+        return me.steinborn.krypton.network.util.VarIntUtil.getVarIntLength(i); // Graphene - krypton: network.microopt
     }
 
     public static boolean hasContinuationBit(byte b) {
@@ -39,6 +49,8 @@ public class VarInt {
     }
 
     public static ByteBuf write(ByteBuf buf, int i) {
+        // Graphene start - krypton: optimized version
+        /*
         while((i & -128) != 0) {
             buf.writeByte(i & 127 | 128);
             i >>>= 7;
@@ -46,5 +58,46 @@ public class VarInt {
 
         buf.writeByte(i);
         return buf;
+        */
+        // Graphene end
+
+        // Graphene start - krypton: network.microopt
+        // Peel the one and two byte count cases explicitly as they are the most common VarInt sizes
+        // that the server will send, to improve inlining.
+        if ((i & (0xFFFFFFFF << 7)) == 0) {
+            buf.writeByte(i);
+        } else if ((i & (0xFFFFFFFF << 14)) == 0) {
+            int w = (i & 0x7F | 0x80) << 8 | (i >>> 7);
+            buf.writeShort(w);
+        } else {
+            writeVarIntFull(buf, i);
+        }
+
+        return buf;
+        // Graphene end
+    }
+
+    // Graphene start - krypton: network.microopt
+    private static void writeVarIntFull(ByteBuf buf, int i) {
+        // See https://steinborn.me/posts/performance/how-fast-can-you-write-a-varint/
+        if ((i & (0xFFFFFFFF << 7)) == 0) {
+            buf.writeByte(i);
+        } else if ((i & (0xFFFFFFFF << 14)) == 0) {
+            int w = (i & 0x7F | 0x80) << 8 | (i >>> 7);
+            buf.writeShort(w);
+        } else if ((i & (0xFFFFFFFF << 21)) == 0) {
+            int w = (i & 0x7F | 0x80) << 16 | ((i >>> 7) & 0x7F | 0x80) << 8 | (i >>> 14);
+            buf.writeMedium(w);
+        } else if ((i & (0xFFFFFFFF << 28)) == 0) {
+            int w = (i & 0x7F | 0x80) << 24 | (((i >>> 7) & 0x7F | 0x80) << 16)
+                    | ((i >>> 14) & 0x7F | 0x80) << 8 | (i >>> 21);
+            buf.writeInt(w);
+        } else {
+            int w = (i & 0x7F | 0x80) << 24 | ((i >>> 7) & 0x7F | 0x80) << 16
+                    | ((i >>> 14) & 0x7F | 0x80) << 8 | ((i >>> 21) & 0x7F | 0x80);
+            buf.writeInt(w);
+            buf.writeByte(i >>> 28);
+        }
     }
+    // Graphene end
 }
